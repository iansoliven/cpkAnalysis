<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Post-Processing Menu - CPK Analysis</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        line-height: 1.7;
        color: #1a1a1a;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem 1rem;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        overflow: hidden;
      }

      header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2.5rem 2rem;
        text-align: center;
      }

      header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      header p {
        font-size: 1.1rem;
        opacity: 0.95;
      }

      nav {
        background: #f8f9fb;
        padding: 1rem 2rem;
        border-bottom: 2px solid #e1e4e8;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      nav a {
        color: #667eea;
        text-decoration: none;
        font-weight: 600;
        margin-right: 1.5rem;
        transition: color 0.2s;
      }

      nav a:hover {
        color: #764ba2;
      }

      .content {
        padding: 3rem 2rem;
      }

      h2 {
        color: #004c8c;
        font-size: 1.8rem;
        margin: 2.5rem 0 1rem 0;
        padding-bottom: 0.5rem;
        border-bottom: 3px solid #667eea;
      }

      h2:first-child {
        margin-top: 0;
      }

      h3 {
        color: #2c5282;
        font-size: 1.4rem;
        margin: 1.8rem 0 0.8rem 0;
      }

      h4 {
        color: #667eea;
        font-size: 1.1rem;
        margin: 1.2rem 0 0.6rem 0;
      }

      p {
        margin: 1rem 0;
        color: #2d3748;
      }

      ul, ol {
        margin: 1rem 0 1rem 2rem;
        color: #2d3748;
      }

      li {
        margin: 0.6rem 0;
        line-height: 1.7;
      }

      code {
        background: #f7fafc;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        color: #c7254e;
        border: 1px solid #f1e5e8;
      }

      pre {
        background: #2d3748;
        color: #e2e8f0;
        padding: 1.5rem;
        border-radius: 8px;
        overflow-x: auto;
        margin: 1.5rem 0;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }

      pre code {
        background: none;
        padding: 0;
        border: none;
        color: #e2e8f0;
        font-size: 0.95rem;
      }

      .info-box {
        background: #e6f3ff;
        border-left: 4px solid #4c9aff;
        padding: 1.2rem;
        margin: 1.5rem 0;
        border-radius: 4px;
      }

      .info-box strong {
        color: #0052cc;
        display: block;
        margin-bottom: 0.5rem;
      }

      .success-box {
        background: #e3fcef;
        border-left: 4px solid #00c853;
        padding: 1.2rem;
        margin: 1.5rem 0;
        border-radius: 4px;
      }

      .success-box strong {
        color: #00875a;
        display: block;
        margin-bottom: 0.5rem;
      }

      .warning-box {
        background: #fff3cd;
        border-left: 4px solid #f39c12;
        padding: 1.2rem;
        margin: 1.5rem 0;
        border-radius: 4px;
      }

      .warning-box strong {
        color: #856404;
        display: block;
        margin-bottom: 0.5rem;
      }

      .card {
        background: #f8f9fb;
        border: 1px solid #e1e4e8;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1.5rem 0;
      }

      .card h3 {
        margin-top: 0;
        color: #667eea;
      }

      .card h4 {
        margin-top: 0;
      }

      a {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      a:hover {
        color: #764ba2;
        text-decoration: underline;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5rem 0;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }

      th, td {
        border: 1px solid #e1e4e8;
        padding: 0.8rem;
        text-align: left;
      }

      th {
        background: #667eea;
        color: white;
        font-weight: 600;
      }

      tr:nth-child(even) {
        background: #f8f9fb;
      }

      footer {
        background: #2d3748;
        color: #e2e8f0;
        padding: 2rem;
        text-align: center;
        font-size: 0.9rem;
      }

      footer a {
        color: #90cdf4;
      }

      .badge {
        display: inline-block;
        background: #667eea;
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-right: 0.5rem;
      }

      .action-card {
        background: linear-gradient(135deg, #f8f9fb 0%, #ffffff 100%);
        border-left: 4px solid #667eea;
        padding: 1.5rem;
        margin: 1.5rem 0;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      .action-card h3 {
        margin-top: 0;
        color: #667eea;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Post-Processing Menu</h1>
        <p>Update limits, regenerate charts, and explore what-if scenarios without re-ingesting data</p>
      </header>

      <nav>
        <a href="index.html">Home</a>
        <a href="getting_started.html">Getting Started</a>
        <a href="cli_reference.html">CLI Reference</a>
        <a href="gui_reference.html">GUI Guide</a>
        <a href="stdf_ingestion.html">STDF Ingestion</a>
      </nav>

      <div class="content">
        <p>
          The post-processing menu provides an interactive interface for modifying workbook limits, recalculating CPK statistics, and regenerating charts without the need to re-ingest STDF data. This powerful feature enables rapid iteration on limit specifications and what-if analysis, saving significant time during characterization and production setup.
        </p>

        <div class="success-box">
          <strong>Key Advantages</strong>
          <ul>
            <li><strong>Fast iteration:</strong> Post-processing operates directly on the existing workbook and intermediate Parquet files. Experiment with different limit scenarios in seconds rather than minutes, without re-parsing large STDF files.</li>
            <li><strong>Formula preservation:</strong> All CPK, CPL, CPU calculations remain as Excel formulas (not static values). This enables dynamic recalculation when limits change and allows for manual what-if analysis directly in Excel.</li>
          </ul>
        </div>

        <h2>Launching the Menu</h2>

        <h3>From the CLI</h3>
        <div class="card">
          <h4>Option 1: Automatic Launch After Analysis</h4>
          <pre><code>python -m cpkanalysis.cli run examples/lot2.stdf \
  --output temp/CPK_Workbook.xlsx \
  --postprocess</code></pre>
          <p>The <code>--postprocess</code> flag automatically opens the menu when pipeline completes.</p>
        </div>

        <div class="card">
          <h4>Option 2: Manual Launch for Existing Workbook</h4>
          <pre><code>python -m cpkanalysis.cli post-process --workbook temp/CPK_Workbook.xlsx</code></pre>
          <p>Open the menu for any previously generated workbook. The associated JSON metadata is loaded automatically.</p>
        </div>

        <h3>From the Console GUI</h3>
        <div class="card">
          <ol>
            <li>Complete a standard analysis run via <code>python -m cpkanalysis.gui</code></li>
            <li>Accept the prompt to launch post-processing immediately, or</li>
            <li>Type <code>post</code> at the <code>post&gt;</code> prompt later in the session</li>
          </ol>
        </div>

        <div class="card">
          <h4>Quick Resume via GUI</h4>
          <pre><code>python -m cpkanalysis.gui --resume FinalizeLimits/shinynew.xlsx</code></pre>
          <p>
            Use <code>--resume</code> to jump straight into the menu for an existing workbook. The GUI reads the workbook's metadata JSON,
            displays a summary of the last post-processing action plus key analysis options, and opens the menu immediately. Provide
            <code>--resume-metadata path/to/file.json</code> if the metadata is stored separately.
          </p>
        </div>

        <div class="info-box">
          <strong>Metadata Requirement</strong>
          The menu requires the workbook's associated JSON metadata file (e.g., <code>CPK_Workbook.json</code>). This file is automatically created during analysis and contains crucial information about test configurations, original STDF limits, and processing history.
        </div>

        <h2>Menu Options Overview</h2>
        <p>The post-processing menu presents eight primary operations:</p>

        <table>
          <thead>
            <tr>
              <th>Option</th>
              <th>Purpose</th>
              <th>Typical Use Case</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>1. Update STDF Limits</strong></td>
              <td>Recalculate ATE limits and regenerate charts</td>
              <td>Tightening limits for production qualification</td>
            </tr>
            <tr>
              <td><strong>2. Apply Spec / What-If Limits</strong></td>
              <td>Work with specification or hypothetical limits</td>
              <td>Evaluating customer specifications or design targets</td>
            </tr>
            <tr>
              <td><strong>3. Calculate Proposed Limits</strong></td>
              <td>Generate limit proposals for target CPK</td>
              <td>Creating new spec proposals for approval</td>
            </tr>
            <tr>
              <td><strong>4. Calculate Proposed Limits (GRR-Based)</strong></td>
              <td>GRR-aware limit proposals with guardband protection</td>
              <td>Production limit setting with measurement system capability</td>
            </tr>
            <tr>
              <td><strong>5. Re-run Last Action</strong></td>
              <td>Repeat previous operation</td>
              <td>Iterative refinement of single test</td>
            </tr>
            <tr>
              <td><strong>6. Reload Workbook</strong></td>
              <td>Discard changes and reload from disk</td>
              <td>Abandoning experimental changes</td>
            </tr>
            <tr>
              <td><strong>7. View Audit Log</strong></td>
              <td>Review operation history</td>
              <td>Understanding what changes were made</td>
            </tr>
            <tr>
              <td><strong>8. Exit Menu</strong></td>
              <td>Save and close</td>
              <td>Finalizing changes</td>
            </tr>
          </tbody>
        </table>

        <h2>Detailed Action Reference</h2>

        <div class="action-card">
          <h3>1. Update STDF Limits</h3>
          <p><span class="badge">Recalculates</span> <span class="badge">Regenerates Charts</span></p>

          <h4>Purpose</h4>
          <p>Update the ATE (Automated Test Equipment) lower and upper limits based on current statistics or a target CPK value. This is the primary action for tightening or loosening test limits while maintaining the same measurement data.</p>

          <h4>Workflow</h4>
          <ol>
            <li><strong>Select scope:</strong> All tests or single test</li>
            <li><strong>Choose test:</strong> If single test, search and select from list</li>
            <li><strong>Provide target CPK:</strong> Optional. Leave blank to keep existing statistics
              <ul>
                <li>Positive value: Compute symmetrical limits around mean for target CPK</li>
                <li>Blank: Reuse current mean/std dev without changing limits</li>
              </ul>
            </li>
            <li><strong>Confirmation:</strong> Review changes before applying</li>
          </ol>

          <h4>What Gets Updated</h4>
          <ul>
            <li>Template sheet: LL (lower limit) and UL (upper limit) columns</li>
            <li>Test List & Limits sheet: STDF limit columns synchronized</li>
            <li>Charts: All histogram, CDF, and time-series charts regenerated with new limit markers</li>
            <li>Excel formulas: CPK, CPL, CPU calculations preserved as formulas (not static values)</li>
            <li>Metadata: Operation logged with timestamp, scope, tests affected, and target CPK</li>
          </ul>

          <h4>Use Cases</h4>
          <ul>
            <li>Production qualification: Tighten limits after characterization</li>
            <li>Yield recovery: Relax limits based on actual process capability</li>
            <li>Multi-site correlation: Harmonize limits across facilities</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>2. Apply Spec / What-If Limits</h3>
          <p><span class="badge">Layered Limits</span> <span class="badge">Non-Destructive</span></p>

          <h4>Purpose</h4>
          <p>Work with specification or hypothetical limits alongside the original STDF limits. This action is non-destructive—it adds additional limit markers to charts without removing STDF markers, enabling side-by-side comparison.</p>

          <h4>Workflow</h4>
          <ol>
            <li><strong>Select scope:</strong> All tests or single test</li>
            <li><strong>Choose test:</strong> If single test, select from list</li>
            <li><strong>Provide target CPK:</strong> Optional
              <ul>
                <li>Blank: Use existing Spec/What-If values from workbook</li>
                <li>Positive value: Compute new Spec/What-If limits for target CPK</li>
              </ul>
            </li>
            <li><strong>Apply:</strong> Updates propagate to charts and Test List sheet</li>
          </ol>

          <h4>What Gets Updated</h4>
          <ul>
            <li>Template sheet: LL_SPEC, UL_SPEC, CPK_SPEC, %YLD LOSS_SPEC columns (or What-If equivalents)</li>
            <li>Test List & Limits: Spec columns synchronized</li>
            <li>Charts: Spec/What-If limit markers added (STDF markers remain)</li>
            <li>Excel formulas: CPK calculations remain formula-driven for dynamic updates</li>
            <li>CPK annotation: Positioned above chart title to show multiple CPK values</li>
          </ul>

          <h4>Use Cases</h4>
          <ul>
            <li>Customer specifications: Compare ATE limits vs. datasheet specs</li>
            <li>Design targets: Evaluate design goals against actual performance</li>
            <li>What-if analysis: Explore impact of tighter/looser limits on yield</li>
            <li>Vendor negotiations: Present data-driven spec proposals</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>3. Calculate Proposed Limits</h3>
          <p><span class="badge">Requires Target CPK</span> <span class="badge">New Columns</span></p>

          <h4>Purpose</h4>
          <p>Generate proposed limit recommendations for a specific target CPK. This action calculates new lower/upper limits, the resulting CPK, and estimated yield loss, providing quantitative data for limit change proposals.</p>

          <h4>Workflow</h4>
          <ol>
            <li><strong>Provide target CPK:</strong> Required (e.g., 1.33, 1.67, 2.0)</li>
            <li><strong>Select scope:</strong> All tests or single test</li>
            <li><strong>Choose test:</strong> If single test, select from list</li>
            <li><strong>Calculate:</strong> Proposed limits computed from mean and std dev</li>
            <li><strong>Review:</strong> Check proposed values before saving</li>
          </ol>

          <h4>What Gets Updated</h4>
          <ul>
            <li>Template sheet: LL_PROP, UL_PROP, CPK_PROP, %YLD LOSS_PROP columns</li>
            <li>Charts: "Proposed" limit markers added to all chart types</li>
            <li>Excel formulas: CPK_PROP remains formula-driven for easy adjustments</li>
            <li>Axis ranges: Automatically expanded to accommodate proposed limits if needed</li>
            <li>Hidden metadata: _PlotAxisRanges sheet updated for consistency</li>
          </ul>

          <h4>Calculation Method</h4>
          <pre><code># For target CPK value (e.g., 1.67):
# Assuming bilateral limits

sigma = std_dev
mean = sample_mean

# Proposed limits for symmetric specification
LL_PROP = mean - (target_CPK × 3 × sigma)
UL_PROP = mean + (target_CPK × 3 × sigma)

# Resulting CPK with proposed limits
CPK_PROP = min((UL_PROP - mean)/(3×sigma), (mean - LL_PROP)/(3×sigma))

# Yield loss estimate (normal distribution assumption)
YLD_LOSS_PROP = proportion outside [LL_PROP, UL_PROP]</code></pre>

          <h4>Use Cases</h4>
          <ul>
            <li>Spec proposals: Generate data-driven limit recommendations</li>
            <li>Quality targets: Determine limits needed for Six Sigma compliance</li>
            <li>Process capability studies: Document achievable CPK levels</li>
            <li>Management reviews: Present quantitative yield vs. quality tradeoffs</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>4. Calculate Proposed Limits (GRR-Based)</h3>
          <p><span class="badge">GRR Data Required</span> <span class="badge">Guardband Protection</span> <span class="badge">New Columns</span></p>

          <h4>Purpose</h4>
          <p>Generate production-ready limit proposals that account for measurement system capability (Gauge R&R). This advanced action computes both specification limits and Final Test (FT) limits with automatic guardband protection, preventing false rejects caused by test equipment variation.</p>

          <div class="info-box">
            <strong>What is GRR Guardband?</strong>
            Gauge Repeatability & Reproducibility (GRR) measures test equipment variation. A guardband is a safety margin between spec limits and test limits that accounts for this variation. Common practice: Reserve 50% or 100% of GRR magnitude as buffer to prevent good parts from failing due to measurement noise.
          </div>

          <h4>Workflow</h4>
          <ol>
            <li><strong>Confirm GRR availability:</strong> User confirms GRR data is available</li>
            <li><strong>Provide GRR directory:</strong> Path to directory containing <code>Total_GRR.xlsx</code></li>
            <li><strong>Enter CPK targets:</strong>
              <ul>
                <li>Minimum FT CPK (e.g., 1.33)</li>
                <li>Maximum FT CPK (e.g., 2.0)</li>
              </ul>
            </li>
            <li><strong>Select scope:</strong> All tests or single test</li>
            <li><strong>Choose test:</strong> If single test, select from list</li>
            <li><strong>Calculate:</strong> Algorithm applies guardband ladder and computes limits</li>
            <li><strong>Review:</strong> Check proposed values, guardband selections, and any spec widening</li>
          </ol>

          <h4>Guardband Selection Algorithm</h4>
          <p>The system first checks if existing ATE limits already satisfy the guardband requirement. If not, it selects the optimal guardband using a three-tier ladder:</p>

          <div class="info-box">
            <strong>Step 0: Check Existing ATE Limits (Skip Logic)</strong>
            Before computing new limits, the system checks if the current LL_ATE and UL_ATE already provide adequate guardband protection:
            <ul>
              <li>Calculate existing guardband widths:
                <ul>
                  <li>Lower guardband width = |LL_ATE - Spec Lower|</li>
                  <li>Upper guardband width = |Spec Upper - UL_ATE|</li>
                </ul>
              </li>
              <li>Check if both widths ≥ GRR requirement (with small tolerance)</li>
              <li>Check if current CPK is within [min CPK, max CPK] range</li>
              <li>If all conditions met:
                <ul>
                  <li><strong>Skip computation and keep existing ATE limits</strong></li>
                  <li>Copy LL_ATE → LL_PROP, UL_ATE → UL_PROP</li>
                  <li>Copy Spec Lower/Upper → Proposed Spec Lower/Upper</li>
                  <li>Calculate guardband percentages for documentation</li>
                  <li>Flag test as "skipped" with reason "guardband_satisfied"</li>
                  <li>This avoids unnecessary limit changes when existing limits are already adequate</li>
                </ul>
              </li>
            </ul>
          </div>

          <p>If existing limits do not satisfy the guardband requirement, proceed with the ladder algorithm:</p>
          <ol>
            <li><strong>Try 100% GRR:</strong> Apply full GRR as guardband (most conservative)
              <ul>
                <li>FT Lower = Spec Lower + GRR, FT Upper = Spec Upper - GRR</li>
                <li>If resulting FT CPK ≥ minimum target: Use 100% GRR ✓</li>
                <li>Otherwise: Proceed to step 2</li>
              </ul>
            </li>
            <li><strong>Try 50% GRR:</strong> Apply half GRR as guardband (balanced approach)
              <ul>
                <li>FT Lower = Spec Lower + (GRR/2), FT Upper = Spec Upper - (GRR/2)</li>
                <li>If resulting FT CPK ≥ minimum target: Use 50% GRR ✓</li>
                <li>Otherwise: Proceed to step 3</li>
              </ul>
            </li>
            <li><strong>Widen Spec:</strong> Use 50% GRR but expand spec limits
              <ul>
                <li>Calculate required spec width to meet minimum CPK target</li>
                <li>Expand spec symmetrically around mean if needed</li>
                <li>Apply 50% GRR guardband on top of widened spec</li>
                <li>Flag test as requiring spec widening (triggers yellow conditional formatting)</li>
                <li>If max CPK constraint is violated, tighten FT limits (not spec limits)</li>
              </ul>
            </li>
          </ol>

          <h4>What Gets Updated</h4>
          <ul>
            <li>Template sheet: LL_PROP, UL_PROP, CPK_PROP, %YLD LOSS_PROP columns (FT limits)</li>
            <li>Template sheet: Seven new columns added:
              <ul>
                <li><strong>Proposed Spec Lower:</strong> Lower specification limit (possibly widened to accommodate guardband + CPK target)</li>
                <li><strong>Proposed Spec Upper:</strong> Upper specification limit (possibly widened to accommodate guardband + CPK target)</li>
                <li><strong>CPK Proposed Spec:</strong> CPK calculated against proposed spec limits (always ≥ FT CPK)</li>
                <li><strong>Lower Guardband:</strong> Absolute guardband width on lower side (FT Lower - Spec Lower, in native units)</li>
                <li><strong>Upper Guardband:</strong> Absolute guardband width on upper side (Spec Upper - FT Upper, in native units)</li>
                <li><strong>Lower Guardband Percent:</strong> Lower guardband as percentage of spec width: (LL_PROP - Proposed Spec Lower) / (Proposed Spec Upper - Proposed Spec Lower) × 100%</li>
                <li><strong>Upper Guardband Percent:</strong> Upper guardband as percentage of spec width: (Proposed Spec Upper - UL_PROP) / (Proposed Spec Upper - Proposed Spec Lower) × 100%</li>
              </ul>
            </li>
            <li>Hidden reference sheet: <code>_GRR_reference</code> created with test-to-GRR mappings
              <ul>
                <li>Used for conditional formatting to highlight spec differences</li>
                <li>Contains test key, name, number, spec limits, and guardband requirement</li>
                <li>Hidden from normal view but accessible for debugging</li>
              </ul>
            </li>
            <li>Conditional formatting: Proposed Spec Lower/Upper columns
              <ul>
                <li>Yellow highlight applied when proposed spec differs from GRR reference spec by more than 1E-6</li>
                <li>Helps identify which tests required spec widening</li>
                <li>Uses Excel formula-based conditional formatting for dynamic updates</li>
              </ul>
            </li>
            <li>Charts: New overlay chart sheets created (e.g., "Histogram_lot2 (Proposed)")
              <ul>
                <li>Shows original measurement data</li>
                <li>Overlays original spec limits (dashed lines)</li>
                <li>Overlays proposed spec limits (solid blue lines)</li>
                <li>Overlays proposed FT limits (solid red lines)</li>
                <li>Annotates with original and proposed CPK values</li>
              </ul>
            </li>
            <li>Metadata: Complete audit trail including:
              <ul>
                <li>GRR directory path</li>
                <li>Min/max CPK targets</li>
                <li>Tests processed, tests skipped (guardband already satisfied), and tests widened</li>
                <li>Per-test guardband decisions ("100% GRR", "50% GRR", or "Existing ATE")</li>
                <li>Per-test skip reasons and guardband percentages</li>
              </ul>
            </li>
          </ul>

          <h4>GRR File Format</h4>
          <p>The system expects a file named <code>Total_GRR.xlsx</code> in the specified directory, containing a sheet named <code>"GRR data"</code> (or using the first sheet as fallback) with these columns:</p>

          <table>
            <thead>
              <tr>
                <th>Column</th>
                <th>Accepted Variations</th>
                <th>Description</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong>Test Number</strong></td>
                <td><code>Test #</code>, <code>Test Num</code>, <code>Test</code></td>
                <td>Numeric test ID (leading zeros and "T" prefix stripped)</td>
              </tr>
              <tr>
                <td><strong>Test Name</strong></td>
                <td><code>Test Name</code>, <code>Description</code></td>
                <td>Test name for matching (normalized, whitespace collapsed)</td>
              </tr>
              <tr>
                <td><strong>Unit</strong></td>
                <td><code>Unit</code>, <code>Units</code></td>
                <td>Measurement units (normalized: V→VOLTS, mA→MILLIAMPS)</td>
              </tr>
              <tr>
                <td><strong>Spec Min</strong></td>
                <td><code>Min\nSpec</code>, <code>Spec Min</code>, <code>Lower Spec</code></td>
                <td>Lower specification limit</td>
              </tr>
              <tr>
                <td><strong>Spec Max</strong></td>
                <td><code>Max\nSpec</code>, <code>Spec Max</code>, <code>Upper Spec</code></td>
                <td>Upper specification limit</td>
              </tr>
              <tr>
                <td><strong>GRR</strong></td>
                <td><code>Worst R&R</code>, R&R columns</td>
                <td>GRR magnitude (worst case across conditions)</td>
              </tr>
            </tbody>
          </table>

          <div class="info-box">
            <strong>Unit Normalization</strong>
            The system automatically normalizes units to handle common aliases:
            <ul>
              <li>V, VOLT → VOLTS</li>
              <li>MV, MILLIVOLT → MILLIVOLTS</li>
              <li>A, AMP → AMPS</li>
              <li>MA, MILLIAMP → MILLIAMPS</li>
              <li>UA, UAMP → UAMPS</li>
            </ul>
            If normalized units still don't match between GRR and workbook data, you'll be warned and the test will be skipped (with optional override).
          </div>

          <h4>Example Calculation: Guardband Already Satisfied (Skip Case)</h4>
          <pre><code>Test: VDD_IO
Original Spec: 3.0V - 3.6V (width = 0.6V)
GRR (Worst R&R): 0.05V
Statistics: Mean = 3.30V, Stdev = 0.04V
Existing ATE Limits: LL_ATE = 3.06V, UL_ATE = 3.54V
Targets: Min FT CPK = 1.33, Max FT CPK = 2.0

Step 0: Check existing ATE limits
  Lower guardband width = |3.06 - 3.0| = 0.06V
  Upper guardband width = |3.6 - 3.54| = 0.06V
  GRR requirement = 0.05V
  Lower check: 0.06V ≥ 0.05V ✓
  Upper check: 0.06V ≥ 0.05V ✓
  Current CPK = min((3.54-3.30)/(3×0.04), (3.30-3.06)/(3×0.04)) = 2.0
  CPK check: 1.33 ≤ 2.0 ≤ 2.0 ✓
  Result: All checks passed → SKIP guardband computation

Final Proposal (No Changes):
  LL_PROP: 3.06V (kept existing LL_ATE)
  UL_PROP: 3.54V (kept existing UL_ATE)
  Proposed Spec Lower: 3.0V (no widening needed)
  Proposed Spec Upper: 3.6V (no widening needed)
  Lower Guardband: 0.06V
  Upper Guardband: 0.06V
  Lower Guardband Percent: (3.06 - 3.0) / 0.6 = 10.0%
  Upper Guardband Percent: (3.6 - 3.54) / 0.6 = 10.0%
  FT CPK: 2.0 ✓
  Spec CPK: 2.5
  Guardband Selection: "Existing ATE"
  Spec Widening: No
  Skipped: Yes (reason: "guardband_satisfied")</code></pre>

          <h4>Example Calculation: Spec Widening Required</h4>
          <pre><code>Test: VDD_CORE
Original Spec: 0.95V - 1.05V (width = 0.10V)
GRR (Worst R&R): 0.02V
Statistics: Mean = 1.00V, Stdev = 0.015V
Existing ATE Limits: LL_ATE = 0.96V, UL_ATE = 1.04V (insufficient guardband)
Targets: Min FT CPK = 1.33, Max FT CPK = 2.0

Step 0: Check existing ATE limits
  Lower guardband width = |0.96 - 0.95| = 0.01V < 0.02V ❌
  Upper guardband width = |1.05 - 1.04| = 0.01V < 0.02V ❌
  Result: Existing guardband insufficient → Proceed to ladder algorithm

Step 1: Try 100% GRR guardband (0.02V)
  FT Limits = [0.95 + 0.02, 1.05 - 0.02] = [0.97V, 1.03V]
  FT CPK = min((1.03-1.00), (1.00-0.97)) / (3×0.015) = 0.67
  Result: 0.67 < 1.33 ❌ (too low, proceed to step 2)

Step 2: Try 50% GRR guardband (0.01V)
  FT Limits = [0.95 + 0.01, 1.05 - 0.01] = [0.96V, 1.04V]
  FT CPK = min((1.04-1.00), (1.00-0.96)) / (3×0.015) = 0.89
  Result: 0.89 < 1.33 ❌ (too low, proceed to step 3)

Step 3: Widen spec and use 50% GRR
  Required FT range for CPK=1.33: 1.00 ± (1.33 × 3 × 0.015) = [0.9401V, 1.0599V]
  Add 50% GRR buffer (0.01V): Spec must be [0.9401 - 0.01, 1.0599 + 0.01] = [0.9301V, 1.0699V]

Final Proposal:
  LL_PROP: 0.94V
  UL_PROP: 1.06V
  Proposed Spec Lower: 0.93V (widened from 0.95V) ← Yellow highlight
  Proposed Spec Upper: 1.07V (widened from 1.05V) ← Yellow highlight
  Lower Guardband: 0.01V
  Upper Guardband: 0.01V
  Lower Guardband Percent: (0.94 - 0.93) / (1.07 - 0.93) ≈ 7.1%
  Upper Guardband Percent: (1.07 - 1.06) / (1.07 - 0.93) ≈ 7.1%
  FT CPK: 1.33 ✓
  Spec CPK: 1.48
  Guardband Selection: "50% GRR"
  Spec Widening: Yes (flagged with conditional formatting)</code></pre>

          <h4>Use Cases</h4>
          <ul>
            <li><strong>Production qualification:</strong> Set initial limits that account for ATE capability</li>
            <li><strong>Limit optimization:</strong> Balance yield protection with measurement uncertainty</li>
            <li><strong>Spec negotiation:</strong> Justify spec widening requests with quantitative GRR data</li>
            <li><strong>Multi-site correlation:</strong> Ensure limits work across test equipment with different GRR</li>
            <li><strong>Cost-benefit analysis:</strong> Compare guardband protection levels (50% vs 100%)</li>
          </ul>

          <h4>Best Practices</h4>
          <ul>
            <li>Run GRR studies at production-representative conditions (temperature, voltage, etc.)</li>
            <li>Use "Worst R&R" column from GRR workbook (accounts for all variation sources)</li>
            <li>Review tests flagged for spec widening with design/product engineering</li>
            <li>Validate proposed limits against actual measurement data using overlay charts</li>
            <li>Document guardband decisions in audit log for regulatory compliance</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>5. Re-run Last Action</h3>
          <p><span class="badge">Quick Repeat</span></p>

          <h4>Purpose</h4>
          <p>Repeat the previous post-processing action with the same parameters. Useful for iterative refinement or applying the same operation to multiple tests sequentially.</p>

          <h4>Behavior</h4>
          <ul>
            <li>Reuses action type, scope, test selection, and target CPK from last operation</li>
            <li>No additional prompts—executes immediately</li>
            <li>Also available via <code>last</code> command in GUI mode</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>6. Reload Workbook</h3>
          <p><span class="badge">Discard Changes</span></p>

          <h4>Purpose</h4>
          <p>Abandon all unsaved modifications and reload the workbook and metadata from disk. Useful for recovering from unwanted changes or picking up external edits.</p>

          <h4>Behavior</h4>
          <ul>
            <li>Prompts for confirmation before discarding</li>
            <li>Reloads Excel workbook from file</li>
            <li>Reloads JSON metadata (loses unsaved audit entries)</li>
            <li>Reinitializes post-processing context</li>
          </ul>

          <h4>Use Cases</h4>
          <ul>
            <li>Undo experiments: Revert to last saved state</li>
            <li>External edits: Pick up manual Excel changes</li>
            <li>Error recovery: Reset after unexpected results</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>7. View Audit Log</h3>
          <p><span class="badge">Traceability</span></p>

          <h4>Purpose</h4>
          <p>Display complete history of post-processing operations, including both saved and pending actions. Provides full traceability for regulatory compliance and debugging.</p>

          <h4>Information Displayed</h4>
          <ul>
            <li>Timestamp of each operation</li>
            <li>Action type (Update STDF, Apply Spec, Calculate Proposed, Calculate Proposed GRR, etc.)</li>
            <li>Scope (all tests or specific test)</li>
            <li>Test identifiers (test numbers and names)</li>
            <li>Parameters (target CPK, limit values, GRR directory, guardband selections)</li>
            <li>Warnings or errors encountered</li>
            <li>Tests widened (for GRR-based actions)</li>
          </ul>
        </div>

        <div class="action-card">
          <h3>8. Exit Menu</h3>
          <p><span class="badge">Save & Close</span></p>

          <h4>Purpose</h4>
          <p>Close the post-processing menu, optionally saving changes.</p>

          <h4>Behavior</h4>
          <ul>
            <li>If changes exist: Prompts to save or discard</li>
            <li>If no changes: Exits immediately</li>
            <li>Returns to <code>post&gt;</code> prompt (GUI mode) or terminates (CLI mode)</li>
          </ul>
        </div>

        <h2>Scope Selection</h2>
        <p>Most actions prompt for scope selection:</p>

        <div class="card">
          <h3>All Tests</h3>
          <p>Apply the operation to every test in the workbook.</p>
          <ul>
            <li><strong>Advantages:</strong> Fast, consistent, batch processing</li>
            <li><strong>Use when:</strong> Applying uniform limit strategy, initial CPK targeting, mass updates</li>
            <li><strong>Caution:</strong> Verify target CPK is appropriate for all test types</li>
          </ul>
        </div>

        <div class="card">
          <h3>Single Test</h3>
          <p>Apply the operation to one specific test.</p>
          <ul>
            <li><strong>Advantages:</strong> Precise control, test-specific tuning</li>
            <li><strong>Use when:</strong> Investigating outliers, custom specifications, iterative refinement</li>
            <li><strong>Selection:</strong> Interactive searchable list (filter by test number or name)</li>
          </ul>
        </div>

        <h2>Target CPK Input</h2>
        <p>Many actions prompt for a target CPK value. Understanding this parameter is crucial:</p>

        <div class="info-box">
          <strong>What is Target CPK?</strong>
          Target CPK represents your desired process capability index. Common values:
          <ul>
            <li><strong>CPK ≥ 1.33:</strong> Minimum acceptable (4-sigma process, ~63 ppm defects)</li>
            <li><strong>CPK ≥ 1.67:</strong> High quality (5-sigma process, ~0.6 ppm defects)</li>
            <li><strong>CPK ≥ 2.0:</strong> Six Sigma (6-sigma process, ~0.002 ppm defects)</li>
          </ul>
        </div>

        <div class="card">
          <h3>Blank Input (No Target CPK)</h3>
          <ul>
            <li>Uses current mean and standard deviation</li>
            <li>Keeps existing limit calculations</li>
            <li>Useful for regenerating charts without changing values</li>
          </ul>
        </div>

        <div class="card">
          <h3>Positive Value (e.g., 1.67)</h3>
          <ul>
            <li>Calculates new symmetrical limits around mean</li>
            <li>Formula: LL = μ - (target_CPK × 3σ), UL = μ + (target_CPK × 3σ)</li>
            <li>Updates CPK and yield loss calculations</li>
            <li>Regenerates charts with new limits</li>
          </ul>
        </div>

        <h2>Chart Regeneration</h2>
        <p>Post-processing automatically regenerates affected charts with enhanced features:</p>

        <div class="card">
          <h3>Limit Markers</h3>
          <p>Different limit types are displayed with distinct visual markers:</p>
          <ul>
            <li><strong>STDF Limits:</strong> Solid lines (original ATE limits)</li>
            <li><strong>Spec Limits:</strong> Dashed lines (specification or datasheet limits)</li>
            <li><strong>What-If Limits:</strong> Dash-dot lines (hypothetical scenarios)</li>
            <li><strong>Proposed Limits:</strong> Dotted lines (recommendations from target CPK)</li>
          </ul>
        </div>

        <div class="card">
          <h3>CPK Text Positioning</h3>
          <p>CPK values are displayed above the chart title to avoid legend clutter:</p>
          <pre><code>CPK: 1.85  |  CPK_SPEC: 1.45  |  CPK_PROP: 1.67

                    Test 100: VDD_CORE
        [Histogram with multiple limit markers...]</code></pre>
        </div>

        <div class="card">
          <h3>Axis Scaling</h3>
          <p>Axes automatically expand to accommodate all limit types:</p>
          <ul>
            <li>Minimum x-axis includes all lower limits with 10% padding</li>
            <li>Maximum x-axis includes all upper limits with 10% padding</li>
            <li>Axis metadata stored in hidden <code>_PlotAxisRanges</code> sheet</li>
            <li>Ensures consistent scaling across multiple chart updates</li>
          </ul>
        </div>

        <h2>Metadata and Audit Trail</h2>

        <div class="success-box">
          <strong>Complete Traceability</strong>
          Every post-processing operation is logged to the metadata JSON file under <code>post_processing.runs</code>, creating a complete audit trail for compliance, debugging, and documentation.
        </div>

        <h3>Audit Entry Structure</h3>
        <pre><code>{
  "post_processing": {
    "runs": [
      {
        "timestamp": "2025-10-11T15:30:45",
        "action": "update_stdf_limits",
        "scope": "single",
        "tests": ["100:VDD_CORE"],
        "parameters": {
          "target_cpk": 1.67
        },
        "warnings": [],
        "charts_regenerated": ["histogram", "cdf", "time_series"]
      }
    ]
  }
}</code></pre>

        <h2>Best Practices</h2>

        <div class="success-box">
          <strong>Iterative Workflow</strong>
          <ul>
            <li>Start with "all tests" to apply uniform strategy</li>
            <li>Review results in Excel</li>
            <li>Use "single test" mode to fine-tune outliers</li>
            <li>Save frequently to create checkpoints</li>
            <li>Use audit log to document rationale for changes</li>
          </ul>
        </div>

        <div class="info-box">
          <strong>File Management</strong>
          <ul>
            <li>Close Excel before running post-processing (avoid file locks)</li>
            <li>Keep workbook and JSON files together (same directory, matching names)</li>
            <li>Version control metadata JSON for traceability</li>
            <li>Use descriptive output filenames (e.g., <code>CPK_v2_tighter_limits.xlsx</code>)</li>
          </ul>
        </div>

        <div class="warning-box">
          <strong>Common Pitfalls</strong>
          <ul>
            <li><strong>Target CPK too high:</strong> May result in limits tighter than measurement noise</li>
            <li><strong>Missing metadata:</strong> Cannot post-process without associated JSON file</li>
            <li><strong>Workbook open in Excel:</strong> Causes save failures due to file lock</li>
            <li><strong>External manual edits:</strong> Use "Reload" to sync before continuing</li>
          </ul>
        </div>

        <h2>Troubleshooting</h2>

        <div class="card">
          <h3>Menu Won't Launch</h3>
          <p><strong>Issue:</strong> Post-processing command fails or menu doesn't appear</p>
          <p><strong>Solutions:</strong></p>
          <ul>
            <li>Verify JSON metadata exists: <code>ls temp/CPK_Workbook.json</code></li>
            <li>Check workbook path is correct (case-sensitive on Linux/Mac)</li>
            <li>Ensure analysis completed successfully (check for errors in pipeline output)</li>
            <li>Try manual launch: <code>python -m cpkanalysis.cli post-process --workbook &lt;path&gt;</code></li>
          </ul>
        </div>

        <div class="card">
          <h3>Charts Not Updating</h3>
          <p><strong>Issue:</strong> Limits change but charts remain unchanged</p>
          <p><strong>Solutions:</strong></p>
          <ul>
            <li>Check if chart generation was disabled in original run (<code>--no-histogram</code>, etc.)</li>
            <li>Verify chart sheets exist in workbook (Histogram, CDF, Time-Series)</li>
            <li>Review warnings displayed after action (may indicate missing data)</li>
            <li>Try "Reload Workbook" and repeat operation</li>
          </ul>
        </div>

        <div class="card">
          <h3>Save Failures</h3>
          <p><strong>Issue:</strong> Cannot save workbook or metadata</p>
          <p><strong>Solutions:</strong></p>
          <ul>
            <li>Close workbook in Excel (file lock)</li>
            <li>Check directory write permissions</li>
            <li>Verify disk space available</li>
            <li>Try saving to different path</li>
          </ul>
        </div>

        <div class="card">
          <h3>Unexpected CPK Values</h3>
          <p><strong>Issue:</strong> Calculated CPK doesn't match expectations</p>
          <p><strong>Solutions:</strong></p>
          <ul>
            <li>Review original statistics (mean, std dev) on template sheet</li>
            <li>Check if outlier filtering was applied during ingestion</li>
            <li>Verify measurement count (low N may cause variance)</li>
            <li>Ensure limits are appropriate for test type (unilateral vs. bilateral)</li>
            <li>Check for data quality issues (PARM_FLG, TEST_FLG filtering)</li>
          </ul>
        </div>

        <h2>Related Documentation</h2>
        <ul>
          <li><a href="getting_started.html">Getting Started</a> — Initial setup and first analysis</li>
          <li><a href="cli_reference.html">CLI Reference</a> — Command-line options and flags</li>
          <li><a href="gui_reference.html">GUI Guide</a> — Interactive console alternative</li>
          <li><a href="stdf_ingestion.html">STDF Ingestion</a> — Understanding data quality and flags</li>
          <li><a href="manual_verification.html">Manual Verification</a> — QA checklist for validating results</li>
        </ul>
      </div>

      <footer>
        <p>CPK Analysis Toolkit | <a href="index.html">Help Center Home</a></p>
        <p>For issues or questions, see the project README or contact your repository maintainer</p>
      </footer>
    </div>
  </body>
</html>
